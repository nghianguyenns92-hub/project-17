<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Tiên Cùng AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        .justified-text { text-align: justify; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;

        window.firebaseInitPromise = (async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                console.log("Firebase initialized. User ID:", userId);

                // Load game state from Firestore
                loadGame();
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showModal('Lỗi', `Lỗi khi kết nối với máy chủ: ${error.message}.`);
            }
        })();

        // Global game state object
        let gameState = {
            chatHistory: [],
            character: null,
            inventory: {
                trang_bi: [],
                tai_phu: { linh_thach: 0 },
                the_luc: []
            },
            imagePrompt: null,
        };

        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const statsBtn = document.getElementById('stats-btn');
        const inventoryBtn = document.getElementById('inventory-btn');
        const wealthBtn = document.getElementById('wealth-btn');
        const factionsBtn = document.getElementById('factions-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const imageBtn = document.getElementById('image-btn');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Function to show modal
        const showModal = (title, content) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modal.classList.remove('hidden');
        };

        // Function to hide modal
        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        const showLoading = (show) => {
            if (show) {
                sendBtn.disabled = true;
                loadingSpinner.classList.remove('hidden');
            } else {
                sendBtn.disabled = false;
                loadingSpinner.classList.add('hidden');
            }
        };

        const addMessage = (sender, text) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded-xl shadow-lg my-2 ${sender === 'user' ? 'bg-blue-600 text-white self-end text-right' : 'bg-gray-700 text-gray-200 self-start'}`;
            messageDiv.innerHTML = `<p class="justified-text">${text}</p>`;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        };
        
        // This function will now call your proxy server instead of the direct Gemini API
        const callGeminiAPI = async (prompt, generationConfig = {}) => {
            const maxRetries = 3;
            let retries = 0;
            let lastError;

            while (retries < maxRetries) {
                try {
                    showLoading(true);
                    const response = await fetch('/gemini-proxy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ prompt, generationConfig }),
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error:', errorText);
                        throw new Error(`Server returned status ${response.status}: ${errorText}`);
                    }

                    const data = await response.json();
                    
                    if (data.candidates && data.candidates.length > 0 &&
                        data.candidates[0].content && data.candidates[0].content.parts &&
                        data.candidates[0].content.parts.length > 0) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid API response structure.");
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    lastError = error;
                    retries++;
                    const delay = Math.pow(2, retries) * 1000; // Exponential backoff
                    console.log(`Retrying in ${delay / 1000} seconds...`);
                    await new Promise(res => setTimeout(res, delay));
                } finally {
                    showLoading(false);
                }
            }
            throw new Error(`Failed to call Gemini API after ${maxRetries} retries. Last error: ${lastError.message}`);
        };

        const generateImage = async (prompt) => {
            try {
                showLoading(true);
                const response = await fetch('/gemini-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        generationConfig: {
                            responseModalities: ["IMAGE", "TEXT"],
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Image API error:', errorText);
                    throw new Error(`Server returned status ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                const imageData = data?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (imageData) {
                    const imageUrl = `data:image/png;base64,${imageData}`;
                    showModal('Ảnh Nhân Vật', `<img src="${imageUrl}" class="rounded-lg shadow-lg">`);
                } else {
                    showModal('Lỗi', 'Không thể tạo ảnh.');
                }
            } catch (error) {
                console.error('Error generating image:', error);
                showModal('Lỗi', `Lỗi khi tạo ảnh: ${error.message}`);
            } finally {
                showLoading(false);
            }
        };

        const processUserInput = async () => {
            const userText = userInput.value.trim();
            if (userText === '') return;

            addMessage('user', userText);
            userInput.value = '';

            try {
                const prompt = JSON.stringify({
                    chatHistory: gameState.chatHistory,
                    userInput: userText,
                    gameState: gameState,
                    previousResponse: gameState.chatHistory[gameState.chatHistory.length - 1]?.text || 'Không có',
                });

                const rawResponse = await callGeminiAPI(
                    `Bạn là một AI kể chuyện Tu Tiên. Hãy tạo ra một câu chuyện tương tác và nhập vai dựa trên nội dung sau, sử dụng JSON để định dạng câu trả lời. \n\n${prompt}`
                );

                const response = JSON.parse(rawResponse);
                addMessage('ai', response.story);

                // Cập nhật trạng thái trò chơi
                gameState.character = response.character;
                gameState.inventory = response.inventory;
                gameState.imagePrompt = response.image_prompt;
                gameState.chatHistory.push({ role: "user", text: userText });
                gameState.chatHistory.push({ role: "ai", text: response.story });

                saveGame();

            } catch (error) {
                console.error("Error processing user input:", error);
                addMessage('ai', 'Đã xảy ra lỗi khi tạo câu chuyện. Vui lòng thử lại.');
            }
        };

        const saveGame = async () => {
            try {
                await window.firebaseInitPromise;
                if (!userId) {
                    showModal('Lỗi', 'Không thể lưu trò chơi. Người dùng chưa được xác thực.');
                    return;
                }
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/game_state`, 'current_game');
                await setDoc(docRef, { state: JSON.stringify(gameState) });
                showModal('Thông báo', 'Đã lưu trò chơi thành công!');
            } catch (error) {
                console.error('Error saving game:', error);
                showModal('Lỗi', `Không thể lưu trò chơi: ${error.message}`);
            }
        };

        const loadGame = async () => {
            try {
                await window.firebaseInitPromise;
                if (!userId) {
                    console.log('User not authenticated, skipping load.');
                    return;
                }
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/game_state`, 'current_game');
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const savedState = JSON.parse(docSnap.data().state);
                        gameState = savedState;
                        console.log("Game state loaded:", gameState);
                        showModal('Thông báo', 'Đã tải trò chơi thành công!');
                        // Load chat history into UI
                        chatBox.innerHTML = '';
                        gameState.chatHistory.forEach(msg => {
                            addMessage(msg.role, msg.text);
                        });
                    } else {
                        console.log("No saved game found!");
                        addMessage('ai', 'Chào mừng đến với thế giới tu tiên. Người là ai, và ngươi muốn bắt đầu hành trình của mình như thế nào?');
                    }
                });
            } catch (error) {
                console.error('Error loading game:', error);
                showModal('Lỗi', `Không thể tải trò chơi: ${error.message}`);
            }
        };
        
        statsBtn.addEventListener('click', () => {
            let statsContent = gameState.character ? 
                `<strong>Tên:</strong> ${gameState.character.ten}<br>
                <strong>Thể chất:</strong> ${gameState.character.the_chat}<br>
                <strong>Linh lực:</strong> ${gameState.character.linh_luc}<br>
                <strong>Tu vi:</strong> ${gameState.character.tu_vi}<br>
                <strong>Đẳng cấp:</strong> ${gameState.character.dang_cap}<br>
                <strong>Tuổi thọ:</strong> ${gameState.character.tuoi_tho_hien_tai} / ${gameState.character.tuoi_tho_toi_da} năm` : 
                "Bạn cần nhập thông tin nhân vật để bắt đầu.";
            showModal('Chỉ số nhân vật', statsContent);
        });
        inventoryBtn.addEventListener('click', () => {
            let itemsHtml = gameState.inventory.trang_bi.length > 0 ?
                gameState.inventory.trang_bi.map(item => `<li>${item.ten} (${item.do_ben_hien_tai}/${item.do_ben_toi_da})</li>`).join('') :
                'Không có trang bị nào.';
            showModal('Trang bị', `<ul>${itemsHtml}</ul>`);
        });
        wealthBtn.addEventListener('click', () => {
            showModal('Tài phú', `<strong>Linh thạch:</strong> ${gameState.inventory.tai_phu.linh_thach}`);
        });
        factionsBtn.addEventListener('click', () => {
            let factionsHtml = gameState.inventory.the_luc.length > 0 ?
                gameState.inventory.the_luc.map(p => `<li>${p.name}</li>`).join('') :
                'Chưa có mối quan hệ hay thế lực nào.';
            showModal('Thế lực & Mối quan hệ', `<ul>${factionsHtml}</ul>`);
        });
        saveBtn.addEventListener('click', saveGame);
        loadBtn.addEventListener('click', loadGame);
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                processUserInput();
            }
        });
        sendBtn.addEventListener('click', processUserInput);
        
        // Initial message
        window.onload = () => {
            setTimeout(() => {
                if (gameState.chatHistory.length === 0) {
                    addMessage('ai', 'Chào mừng đến với thế giới tu tiên. Người là ai, và ngươi muốn bắt đầu hành trình của mình như thế nào?');
                }
            }, 1000);
        };
    </script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Modal Structure -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center pb-3 border-b border-gray-700">
                <h3 id="modal-title" class="text-xl font-bold text-gray-100">Tiêu đề</h3>
                <button id="close-modal" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="modal-body" class="mt-4 text-gray-300 modal-content">
                Nội dung
            </div>
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-xl shadow-lg w-full max-w-4xl p-6 md:p-8 flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6">

        <!-- Main Chat & Input Section -->
        <div class="flex-1 flex flex-col space-y-4">
            <div class="text-center mb-4">
                <h1 class="text-3xl font-bold text-green-400">Tu Tiên Cùng AI</h1>
                <p class="text-gray-400 mt-1">Hành trình của bạn bắt đầu tại đây...</p>
            </div>
            
            <!-- Chat Box -->
            <div id="chat-box" class="flex-1 bg-gray-900 rounded-xl p-4 md:p-6 shadow-inner flex flex-col overflow-y-auto space-y-4">
                <!-- Messages will be appended here -->
            </div>

            <!-- User Input -->
            <div class="flex flex-row space-x-2 mt-4">
                <textarea id="user-input" class="flex-1 bg-gray-700 text-gray-200 p-3 rounded-xl border border-gray-600 focus:outline-none focus:border-green-400 resize-none overflow-hidden placeholder-gray-400" placeholder="Nhập hành động của bạn..."></textarea>
                <button id="send-btn" class="bg-green-600 text-white p-3 rounded-xl shadow-md hover:bg-green-500 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                    </svg>
                </button>
                <div id="loading-spinner" class="hidden flex items-center justify-center">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar Section -->
        <div class="md:w-64 bg-gray-900 rounded-xl p-4 md:p-6 shadow-inner flex flex-col space-y-4">
            <h2 class="text-xl font-bold text-center border-b border-gray-700 pb-2">Hệ thống</h2>
            <button id="stats-btn" class="w-full py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold">Chỉ số</button>
            <button id="inventory-btn" class="w-full py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold">Trang bị</button>
            <button id="wealth-btn" class="w-full py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold">Tài phú</button>
            <button id="factions-btn" class="w-full py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold">Thế lực</button>
            <div class="pt-4 border-t border-gray-700 space-y-2">
                <button id="image-btn" class="w-full py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold">Tạo ảnh nhân vật</button>
                <button id="save-btn" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold">Lưu trữ</button>
                <button id="load-btn" class="w-full py-2 px-4 bg-green-600 hover:bg-green-500 rounded-lg font-bold">Tải lên</button>
            </div>
        </div>
    </div>
</body>
</html>
