<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Tiên Cùng AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;

        window.firebaseInitPromise = (async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Sign in with custom token or anonymously if not available
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase initialized successfully. User ID:", userId);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        })();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        .justified-text { text-align: justify; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex h-screen w-screen overflow-hidden p-4">

    <!-- Main Game Container -->
    <div class="flex-grow flex flex-col p-4 bg-gray-800 rounded-lg shadow-xl mr-4 overflow-hidden">
        <!-- Game Title and Welcome -->
        <header class="text-center mb-4 border-b border-gray-700 pb-2">
            <h1 class="text-3xl font-bold text-teal-400">Tu Tiên Cùng AI</h1>
            <p class="text-sm text-gray-400 mt-1">Hành trình của bạn bắt đầu tại đây...</p>
        </header>

        <!-- Story Display Area -->
        <div id="story-display" class="flex-grow overflow-y-auto pr-2 mb-4 bg-gray-800 rounded-md">
            <!-- Initial content generated by JS -->
            <p class="text-gray-300">Chào mừng đến với thế giới tu tiên. Ngươi là ai, và ngươi muốn bắt đầu hành trình của mình như thế nào?</p>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center text-teal-400 mb-2">
            Đang suy tư...
        </div>

        <!-- User Input Area -->
        <div class="flex flex-col space-y-2">
            <div class="flex items-center space-x-2">
                <textarea id="user-input" class="flex-grow p-3 bg-gray-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-all duration-200 resize-none" rows="1" placeholder="Nhập hành động của bạn..."></textarea>
                <button id="send-btn" class="px-6 py-3 bg-teal-600 hover:bg-teal-700 transition-colors duration-200 rounded-lg font-bold">Gửi</button>
            </div>
        </div>
    </div>

    <!-- Right-side Menu/Sidebar -->
    <div class="flex-shrink-0 w-64 p-4 bg-gray-800 rounded-lg shadow-xl flex flex-col items-center space-y-4">
        <h2 class="text-2xl font-bold text-gray-300">Hệ thống</h2>
        <p id="user-id-display" class="text-sm text-gray-400 break-words w-full text-center"></p>
        <button id="stats-btn" class="w-full py-3 bg-gray-700 hover:bg-gray-600 transition-colors duration-200 rounded-lg font-bold">Chỉ số</button>
        <button id="inventory-btn" class="w-full py-3 bg-gray-700 hover:bg-gray-600 transition-colors duration-200 rounded-lg font-bold">Trang bị</button>
        <button id="wealth-btn" class="w-full py-3 bg-gray-700 hover:bg-gray-600 transition-colors duration-200 rounded-lg font-bold">Tài phú</button>
        <button id="factions-btn" class="w-full py-3 bg-gray-700 hover:bg-gray-600 transition-colors duration-200 rounded-lg font-bold">Thế lực</button>
        <button id="save-btn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 rounded-lg font-bold mt-auto">Lưu trữ</button>
        <button id="load-btn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 rounded-lg font-bold">Tải lên</button>
    </div>

    <!-- Custom Modal for displaying information -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-lg w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-teal-400"></h3>
            <div id="modal-body" class="text-gray-300 max-h-96 overflow-y-auto"></div>
            <button id="close-modal-btn" class="mt-4 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold">Đóng</button>
        </div>
    </div>

    <script type="module">
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Game State and UI Elements
        let gameState = {
            story: [{ role: "model", content: "Chào mừng đến với thế giới tu tiên. Ngươi là ai, và ngươi muốn bắt đầu hành trình của mình như thế nào?" }],
            character: {
                name: null,
                tu_vi: "Phàm nhân",
                tieu_canh_gioi: 1,
                tuoi_tho_hien_tai: 15,
                tuoi_tho_toi_da: 100,
                linh_luc: 0,
                nhuc_than: 0,
                nguyen_than: 0,
                thien_phu: "Thường",
            },
            inventory: {
                trang_bi: [],
                tai_phu: { linh_thach: 0 },
                the_luc: [],
            },
            isProcessing: false,
            isInitialized: false,
        };

        const tuViData = {
            "Phàm nhân": { max_tieu_canh_gioi: 1, tuoi_tho_toi_da: 100, linh_luc: 0 },
            "Luyện Khí": { max_tieu_canh_gioi: 13, tuoi_tho_toi_da: 200, linh_luc: 1300 },
        };

        // DOM elements
        const storyDisplay = document.getElementById('story-display');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const statsBtn = document.getElementById('stats-btn');
        const inventoryBtn = document.getElementById('inventory-btn');
        const wealthBtn = document.getElementById('wealth-btn');
        const factionsBtn = document.getElementById('factions-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // UI Rendering Functions
        const updateStoryDisplay = () => {
            storyDisplay.innerHTML = '';
            gameState.story.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('mb-4', 'p-4', 'rounded-lg');
                if (message.role === 'user') {
                    messageDiv.classList.add('bg-gray-700', 'text-right');
                } else {
                    messageDiv.classList.add('bg-gray-900', 'text-left');
                }
                const messageText = document.createElement('p');
                messageText.classList.add('whitespace-pre-wrap', 'justified-text');
                messageText.textContent = message.content;
                messageDiv.appendChild(messageText);
                storyDisplay.appendChild(messageDiv);
            });
            if (storyDisplay.lastElementChild) {
                storyDisplay.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };

        const showModal = (title, content) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('flex');
        };

        const hideModal = () => {
            modalBackdrop.classList.remove('flex');
            modalBackdrop.classList.add('hidden');
        };

        // LLM Interaction
        const callGeminiApi = async (prompt) => {
            const proxyUrl = 'http://localhost:3000/gemini-proxy'; // Cập nhật đường dẫn
            const payload = { prompt: prompt };

            let retryCount = 0;
            const maxRetries = 5;

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.status === 429) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                        retryCount++;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`Proxy call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    }
                } catch (error) {
                    console.error("Proxy call failed or JSON parse error:", error);
                    break;
                }
            }
            return null;
        };
        
        // Game Logic
        const processUserAction = async (action) => {
            let responseText = "Đã xảy ra lỗi khi tạo câu chuyện. Vui lòng thử lại.";
            let prompt = "";
            
            if (!gameState.isInitialized) {
                if (action.length > 20) {
                    gameState.character.name = "Trần Dương";
                    gameState.isInitialized = true;
                    responseText = "Câu chuyện của Trần Dương bắt đầu từ đây...";
                } else {
                    gameState.character.name = action;
                    gameState.isInitialized = true;
                    responseText = `Chào mừng, ${action}! Hành trình tu tiên của ngươi sẽ bắt đầu ở một thôn làng nhỏ ở vùng Giang Nam, nơi ngươi được biết đến là một phàm nhân bình thường, nhưng lại mang trong mình một bí ẩn lớn.`;
                }
            } else {
                prompt = `
                    Bạn là một AI kể chuyện tu tiên.
                    Thông tin nhân vật: ${JSON.stringify(gameState.character)}
                    Diễn biến gần đây: ${gameState.story.slice(-3).map(m => `${m.role}: ${m.content}`).join('\n')}
                    Hành động của người chơi: "${action}"
                    Hãy tiếp tục câu chuyện tu tiên, cốt truyện cần mạch lạc, hấp dẫn.
                `;
                const aiResponseRaw = await callGeminiApi(prompt);
                if (aiResponseRaw) {
                    responseText = aiResponseRaw.trim();
                }
            }

            gameState.story.push({ role: "model", content: responseText });
            updateStoryDisplay();
            loadingIndicator.classList.add('hidden');
        };

        const handleSend = async () => {
            if (gameState.isProcessing) return;
            const action = userInput.value.trim();
            if (action === '') return;

            gameState.isProcessing = true;
            loadingIndicator.classList.remove('hidden');
            sendBtn.disabled = true;
            userInput.disabled = true;

            try {
                if (!gameState.isInitialized) {
                    await processUserAction(action);
                } else {
                    gameState.story.push({ role: "user", content: action });
                    updateStoryDisplay();
                    await processUserAction(action);
                }
            } catch (error) {
                const errorMessage = "Đã xảy ra lỗi hệ thống. Vui lòng thử lại sau.";
                gameState.story.push({ role: "model", content: errorMessage });
                updateStoryDisplay();
            } finally {
                userInput.value = '';
                gameState.isProcessing = false;
                loadingIndicator.classList.add('hidden');
                sendBtn.disabled = false;
                userInput.disabled = false;
            }
        };
        
        // Firestore Save/Load Functions
        const saveGame = async () => {
            try {
                await window.firebaseInitPromise;
                if (!userId || !db) {
                    showModal('Lỗi', 'Không thể lưu trò chơi. Firebase chưa được khởi tạo.');
                    return;
                }
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/saves/save_data`);
                await setDoc(docRef, { data: JSON.stringify(gameState) });
                showModal('Lưu trữ', 'Đã lưu trò chơi thành công vào đám mây!');
            } catch (error) {
                console.error("Error saving game state to Firestore:", error);
                showModal('Lỗi', 'Không thể lưu trò chơi. Vui lòng kiểm tra console.');
            }
        };

        const loadGame = async () => {
            try {
                await window.firebaseInitPromise;
                if (!userId || !db) {
                    showModal('Lỗi', 'Không thể tải trò chơi. Firebase chưa được khởi tạo.');
                    return;
                }
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/saves/save_data`);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const loadedState = JSON.parse(docSnap.data().data);
                    gameState = loadedState;
                    updateStoryDisplay();
                    showModal('Tải lên', 'Đã tải trò chơi thành công từ đám mây!');
                } else {
                    showModal('Tải lên', 'Không tìm thấy dữ liệu lưu trữ.');
                }
            } catch (error) {
                console.error("Error loading game state from Firestore:", error);
                showModal('Lỗi', 'Không thể tải trò chơi. Vui lòng kiểm tra console.');
            }
        };

        // Event Listeners and Initial Setup
        window.onload = async function() {
            await window.firebaseInitPromise;
            if (userId) {
                userIdDisplay.textContent = `ID người dùng: ${userId}`;
            }
        };
        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });
        closeModalBtn.addEventListener('click', hideModal);
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                hideModal();
            }
        });
        statsBtn.addEventListener('click', () => {
            let statsContent = gameState.character.name ? 
                `<strong>Tên:</strong> ${gameState.character.name}<br><strong>Tu vi:</strong> ${gameState.character.tu_vi} (Tiểu cảnh giới: ${gameState.character.tieu_canh_gioi})<br><strong>Tuổi thọ:</strong> ${gameState.character.tuoi_tho_hien_tai} / ${gameState.character.tuoi_tho_toi_da} năm` :
                "Bạn cần nhập thông tin nhân vật để bắt đầu.";
            showModal('Chỉ số nhân vật', statsContent);
        });
        inventoryBtn.addEventListener('click', () => {
            let itemsHtml = gameState.inventory.trang_bi.length > 0 ?
                gameState.inventory.trang_bi.map(item => `<li>${item.ten} (${item.do_ben_hien_tai}/${item.do_ben_toi_da})</li>`).join('') :
                'Không có trang bị nào.';
            showModal('Trang bị', `<ul>${itemsHtml}</ul>`);
        });
        wealthBtn.addEventListener('click', () => {
            showModal('Tài phú', `<strong>Linh thạch:</strong> ${gameState.inventory.tai_phu.linh_thach}`);
        });
        factionsBtn.addEventListener('click', () => {
            let factionsHtml = gameState.inventory.the_luc.length > 0 ?
                gameState.inventory.the_luc.map(p => `<li>${p.name}</li>`).join('') :
                'Chưa có mối quan hệ hay thế lực nào.';
            showModal('Thế lực & Mối quan hệ', `<ul>${factionsHtml}</ul>`);
        });
        saveBtn.addEventListener('click', saveGame);
        loadBtn.addEventListener('click', loadGame);
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
        });

        updateStoryDisplay();
    </script>
</body>
</html>
